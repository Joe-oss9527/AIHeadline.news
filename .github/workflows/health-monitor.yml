# æ•°æ®å¥åº·ç›‘æŽ§å·¥ä½œæµ
name: News Data Health Monitor

on:
  # æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡
  schedule:
    - cron: '0 * * * *'

  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      max-age-hours:
        description: 'Maximum age of news data in hours'
        required: false
        default: '6'
        type: string

  # åœ¨æ•°æ®åŒæ­¥åŽæ£€æŸ¥
  workflow_run:
    workflows: ["Sync News Data from Archive", "Deploy AI News to Cloudflare & GitHub Pages"]
    types: [completed]

permissions:
  contents: read
  actions: read

concurrency:
  group: "health-monitor"
  cancel-in-progress: true

jobs:
  health-check:
    runs-on: ubuntu-24.04
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 1

      - name: Run health check
        id: health-check
        uses: ./.github/actions/health-check
        with:
          max-age-hours: ${{ inputs.max-age-hours || '6' }}
          telegram-token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          telegram-chat-id: ${{ secrets.TELEGRAM_CHAT_ID }}

      - name: Handle unhealthy status
        if: steps.health-check.outputs.status != 'healthy'
        run: |
          echo "::warning::News data health check failed"
          echo "Status: ${{ steps.health-check.outputs.status }}"
          echo "Data age: ${{ steps.health-check.outputs.latest-data-age }} hours"

          # å¦‚æžœæ•°æ®è¿‡æœŸä¸”è¶…è¿‡12å°æ—¶ï¼Œè§¦å‘å¼ºåˆ¶åŒæ­¥
          if [[ "${{ steps.health-check.outputs.status }}" == "stale" ]] &&
             [[ "${{ steps.health-check.outputs.latest-data-age }}" -gt 12 ]]; then
            echo "::notice::Triggering emergency sync due to stale data"

            # è§¦å‘æ•°æ®åŒæ­¥å·¥ä½œæµ
            gh workflow run sync-news-data.yml \
              --field force_sync=true \
              --field reason="emergency-sync-stale-data"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create issue on persistent failures
        if: steps.health-check.outputs.status == 'error'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'data-sync-failure',
              state: 'open'
            });

            // å¦‚æžœå·²æœ‰ç›¸å…³issueä¸”åœ¨24å°æ—¶å†…åˆ›å»ºï¼Œåˆ™ä¸é‡å¤åˆ›å»º
            const recentIssue = issues.find(issue => {
              const createdAt = new Date(issue.created_at);
              const now = new Date();
              const hoursDiff = (now - createdAt) / (1000 * 60 * 60);
              return hoursDiff < 24;
            });

            if (!recentIssue) {
              const issueBody = `## æ•°æ®åŒæ­¥æ•…éšœæŠ¥å‘Š

**æ£€æµ‹æ—¶é—´**: ${new Date().toISOString()}
**çŠ¶æ€**: ${{ steps.health-check.outputs.status }}
**æ•°æ®å¹´é¾„**: ${{ steps.health-check.outputs.latest-data-age }} å°æ—¶

### é—®é¢˜æè¿°
æ•°æ®åŒæ­¥å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œéœ€è¦æ‰‹åŠ¨ä»‹å…¥å¤„ç†ã€‚

### å»ºè®®æ“ä½œ
1. æ£€æŸ¥ GitHub Actions å·¥ä½œæµè¿è¡ŒçŠ¶æ€
2. éªŒè¯ ai-briefing-archive ä»“åº“æ˜¯å¦æ­£å¸¸æ›´æ–°
3. æ£€æŸ¥å­æ¨¡å—é…ç½®å’Œæƒé™è®¾ç½®
4. æ‰‹åŠ¨è§¦å‘æ•°æ®åŒæ­¥å·¥ä½œæµ

### ç›¸å…³é“¾æŽ¥
- [æ•°æ®åŒæ­¥å·¥ä½œæµ](${context.payload.repository.html_url}/actions/workflows/sync-news-data.yml)
- [å¥åº·ç›‘æŽ§å·¥ä½œæµ](${context.payload.repository.html_url}/actions/workflows/health-monitor.yml)

---
*æ­¤issueç”±è‡ªåŠ¨åŒ–å¥åº·ç›‘æŽ§ç³»ç»Ÿåˆ›å»º*`;

              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ðŸš¨ æ•°æ®åŒæ­¥æ•…éšœ - ${new Date().toLocaleDateString('zh-CN')}`,
                body: issueBody,
                labels: ['data-sync-failure', 'automated', 'urgent']
              });

              console.log('Created new issue for data sync failure');
            } else {
              console.log('Recent issue already exists, skipping creation');
            }

      - name: Update status badge
        run: |
          STATUS="${{ steps.health-check.outputs.status }}"
          DATA_AGE="${{ steps.health-check.outputs.latest-data-age }}"

          case "$STATUS" in
            "healthy")
              BADGE_COLOR="brightgreen"
              BADGE_MESSAGE="æ•°æ®æ­£å¸¸"
              ;;
            "stale")
              BADGE_COLOR="yellow"
              BADGE_MESSAGE="æ•°æ®è¿‡æœŸ (${DATA_AGE}h)"
              ;;
            "error")
              BADGE_COLOR="red"
              BADGE_MESSAGE="åŒæ­¥æ•…éšœ"
              ;;
          esac

          echo "Health status: $STATUS"
          echo "Badge: $BADGE_MESSAGE ($BADGE_COLOR)"

          # è¿™é‡Œå¯ä»¥æ›´æ–°READMEä¸­çš„çŠ¶æ€å¾½ç« ï¼Œæˆ–å‘é€åˆ°çŠ¶æ€é¡µé¢
          # å…·ä½“å®žçŽ°å–å†³äºŽä½ çš„éœ€æ±‚