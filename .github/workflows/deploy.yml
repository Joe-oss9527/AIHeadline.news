# .github/workflows/deploy.yml
name: Deploy AI News to Cloudflare & GitHub Pages

on:
  schedule:
    - cron: '0 0 * * *' # æ¯å¤©UTC 0ç‚¹ (åŒ—äº¬æ—¶é—´8ç‚¹)
  workflow_dispatch:
  push:
    branches:
      - main

# è®¾ç½®GITHUB_TOKENçš„æƒé™
permissions:
  contents: write  # éœ€è¦å†™æƒé™æ¥è‡ªåŠ¨æ›´æ–°submodule
  pages: write
  id-token: write

# åªå…è®¸ä¸€ä¸ªå¹¶å‘éƒ¨ç½²ï¼Œè·³è¿‡æ­£åœ¨è¿è¡Œå’Œæœ€æ–°é˜Ÿåˆ—ä¹‹é—´çš„è¿è¡Œé˜Ÿåˆ—
concurrency:
  group: "pages"
  cancel-in-progress: false

# é»˜è®¤è®¾ç½®
defaults:
  run:
    shell: bash

jobs:
  # æ„å»ºä»»åŠ¡
  build:
    runs-on: ubuntu-24.04
    env:
      HUGO_VERSION: 0.148.1
    steps:
      # æ­¥éª¤1: å®‰è£…Hugo CLI
      - name: Install Hugo CLI
        run: |
          wget -O ${{ runner.temp }}/hugo.deb https://github.com/gohugoio/hugo/releases/download/v${HUGO_VERSION}/hugo_extended_${HUGO_VERSION}_linux-amd64.deb \
          && sudo dpkg -i ${{ runner.temp }}/hugo.deb
      
      # æ­¥éª¤2: æ£€å‡ºç½‘ç«™ä»£ç ä»“åº“
      - name: Checkout website repo
        uses: actions/checkout@v4  # ä½¿ç”¨ v4 æ ‡ç­¾
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Update submodules
        run: |
          # Initialize and update to latest remote commit
          git submodule update --init --remote source-news
          # Check if submodule was updated and commit if necessary
          if ! git diff --quiet source-news; then
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git add source-news
            git commit -m "chore(submodule): auto-update source-news to latest

ğŸ¤– Generated with [Claude Code](https://claude.ai/code)

Co-Authored-By: Claude <noreply@anthropic.com>"
            git push
          fi

      - name: Restore sync cache
        uses: actions/cache@v4
        with:
          path: ./.cache
          key: sync-state-${{ github.ref_name }}-${{ github.run_id }}
          restore-keys: |
            sync-state-${{ github.ref_name }}-
            sync-state-

      - name: Compute changed dates
        id: changed
        run: |
          set -euo pipefail
          mkdir -p .cache
          STATE_FILE=.cache/source_news_sha
          OLD_SUB=""
          if [[ -f "$STATE_FILE" ]]; then
            OLD_SUB="$(cat "$STATE_FILE" || true)"
          fi
          # è¯»å–å½“å‰è¶…çº§é¡¹ç›®ä¸­çš„ submodule æäº¤æŒ‡é’ˆ
          NEW_SUB="$(git ls-tree HEAD source-news | awk '{print $3}')"
          echo "Old submodule SHA: ${OLD_SUB:-<none>}"
          echo "New submodule SHA: ${NEW_SUB:-<none>}"
          CHANGED_DATES=""
          if [[ -n "${OLD_SUB}" && -n "${NEW_SUB}" && "${OLD_SUB}" != "${NEW_SUB}" ]]; then
            # ç¡®ä¿ submodule ä»“åº“åŒ…å«æ‰€éœ€å¯¹è±¡
            git -C source-news fetch --depth=500 origin || true
            # åˆ—å‡ºå˜æ›´çš„ briefing markdown æ–‡ä»¶ï¼Œæå–æ—¥æœŸ
            CHANGED_FILES="$(git -C source-news diff --name-only "${OLD_SUB}" "${NEW_SUB}" -- '*/briefing_*.md' || true)"
            if [[ -n "${CHANGED_FILES}" ]]; then
              CHANGED_DATES=$(printf '%s\n' "${CHANGED_FILES}" | sed -n 's#.*briefing_\([0-9]\{8\}\)T[0-9]\{6\}Z\.md#\1#p' | sort -u | paste -sd, -)
            fi
          fi
          echo "CHANGED_DATES=${CHANGED_DATES}" | tee -a "$GITHUB_ENV"
          # æ£€æµ‹ç«™ç‚¹ä»£ç /æ¨¡æ¿æ˜¯å¦å˜æ›´ï¼ˆéœ€è¦ç«‹å³ç”Ÿæ•ˆï¼‰
          CODE_CHANGED_FILES="$(git diff --name-only "${{ github.event.before }}" "${{ github.sha }}" -- .github/scripts .github/templates layouts hugo.toml assets static archetypes || true)"
          if [[ -n "$CODE_CHANGED_FILES" ]]; then
            CODE_CHANGED="true"
            echo "CODE_CHANGED=true" | tee -a "$GITHUB_ENV"
          else
            CODE_CHANGED="false"
            echo "CODE_CHANGED=false" | tee -a "$GITHUB_ENV"
          fi
          # å†³å®šåŒæ­¥æ¨¡å¼ï¼šé¦–æ¬¡è¿è¡Œæˆ–æ¯å‘¨æ—¥ï¼ˆUTCï¼‰å…¨é‡ï¼Œå¦åˆ™å¢é‡
          DOW=$(date -u +%u)
          if [[ ! -f "$STATE_FILE" || -z "${OLD_SUB}" ]]; then
            echo "SYNC_MODE=full" | tee -a "$GITHUB_ENV"
            echo "First run detected -> full rebuild"
          elif [[ "$DOW" == "7" ]]; then
            echo "SYNC_MODE=full" | tee -a "$GITHUB_ENV"
          elif [[ "$CODE_CHANGED" == "true" ]]; then
            echo "SYNC_MODE=full" | tee -a "$GITHUB_ENV"
            echo "Site code/templates changed -> full rebuild"
          elif [[ "${GITHUB_EVENT_NAME}" == "push" && -z "${CHANGED_DATES}" ]]; then
            echo "SYNC_MODE=full" | tee -a "$GITHUB_ENV"
            echo "Push with no content changes -> full rebuild"
          else
            echo "SYNC_MODE=incremental" | tee -a "$GITHUB_ENV"
          fi
          # ä¿å­˜æœ¬æ¬¡ submodule æŒ‡é’ˆ
          printf '%s' "${NEW_SUB}" > "$STATE_FILE"

      # æ­¥éª¤4: åŒæ­¥æ–°é—»æ–‡ä»¶ï¼ˆå¢é‡/å…¨é‡æŒ‰ SYNC_MODEï¼‰
      - name: Sync markdown files
        run: |
          chmod +x ./.github/scripts/sync-news.sh
          ./.github/scripts/sync-news.sh --mode="${SYNC_MODE}" --dates="${CHANGED_DATES}"

      # æ­¥éª¤5: è®¾ç½®Pages
      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v5  # ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬

      # æ­¥éª¤6: æ„å»ºç½‘ç«™
      - name: Restore Hugo cache
        uses: actions/cache@v4
        with:
          path: ./.cache/hugo_cache
          key: hugo-cache-${{ runner.os }}-${{ github.ref_name }}-${{ github.run_id }}
          restore-keys: |
            hugo-cache-${{ runner.os }}-${{ github.ref_name }}-
            hugo-cache-${{ runner.os }}-

      - name: Build with Hugo
        env:
          HUGO_CACHEDIR: ${{ github.workspace }}/.cache/hugo_cache
          HUGO_ENVIRONMENT: production
        run: |
          hugo \
            --gc \
            --minify \
            --baseURL "${{ steps.pages.outputs.base_url }}/"

      # æ­¥éª¤7: ä¸Šä¼  GitHub Pages æ„å»ºäº§ç‰©
      - name: Upload GitHub Pages artifact
        uses: actions/upload-pages-artifact@v4  # Pages ä¸“ç”¨ action ä¿æŒ v3
        with:
          path: ./public

  # éƒ¨ç½²åˆ°GitHub Pages
  deploy-gh-pages:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-24.04
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4  # ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬

  # éƒ¨ç½²åˆ°Cloudflare Worker
  deploy-cf-worker:
    runs-on: ubuntu-24.04
    if: github.ref == 'refs/heads/main'
    env:
      HUGO_VERSION: 0.148.1
    steps:
      # æ­¥éª¤1: æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Update submodules
        run: |
          # Initialize and update to latest remote commit
          git submodule update --init --remote source-news
          # Check if submodule was updated and commit if necessary
          if ! git diff --quiet source-news; then
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git add source-news
            git commit -m "chore(submodule): auto-update source-news to latest

ğŸ¤– Generated with [Claude Code](https://claude.ai/code)

Co-Authored-By: Claude <noreply@anthropic.com>"
            git push
          fi

      - name: Restore sync cache
        uses: actions/cache@v4
        with:
          path: ./.cache
          key: sync-state-${{ github.ref_name }}-${{ github.run_id }}
          restore-keys: |
            sync-state-${{ github.ref_name }}-
            sync-state-

      - name: Compute changed dates
        id: changed
        run: |
          set -euo pipefail
          mkdir -p .cache
          STATE_FILE=.cache/source_news_sha
          OLD_SUB=""
          if [[ -f "$STATE_FILE" ]]; then
            OLD_SUB="$(cat "$STATE_FILE" || true)"
          fi
          NEW_SUB="$(git ls-tree HEAD source-news | awk '{print $3}')"
          echo "Old submodule SHA: ${OLD_SUB:-<none>}"
          echo "New submodule SHA: ${NEW_SUB:-<none>}"
          CHANGED_DATES=""
          if [[ -n "${OLD_SUB}" && -n "${NEW_SUB}" && "${OLD_SUB}" != "${NEW_SUB}" ]]; then
            git -C source-news fetch --depth=500 origin || true
            CHANGED_FILES="$(git -C source-news diff --name-only "${OLD_SUB}" "${NEW_SUB}" -- '*/briefing_*.md' || true)"
            if [[ -n "${CHANGED_FILES}" ]]; then
              CHANGED_DATES=$(printf '%s\n' "${CHANGED_FILES}" | sed -n 's#.*briefing_\([0-9]\{8\}\)T[0-9]\{6\}Z\.md#\1#p' | sort -u | paste -sd, -)
            fi
          fi
          echo "CHANGED_DATES=${CHANGED_DATES}" | tee -a "$GITHUB_ENV"
          CODE_CHANGED_FILES="$(git diff --name-only "${{ github.event.before }}" "${{ github.sha }}" -- .github/scripts .github/templates layouts hugo.toml assets static archetypes || true)"
          if [[ -n "$CODE_CHANGED_FILES" ]]; then
            CODE_CHANGED="true"
            echo "CODE_CHANGED=true" | tee -a "$GITHUB_ENV"
          else
            CODE_CHANGED="false"
            echo "CODE_CHANGED=false" | tee -a "$GITHUB_ENV"
          fi
          DOW=$(date -u +%u)
          if [[ ! -f "$STATE_FILE" || -z "${OLD_SUB}" ]]; then
            echo "SYNC_MODE=full" | tee -a "$GITHUB_ENV"
            echo "First run detected -> full rebuild"
          elif [[ "$DOW" == "7" ]]; then
            echo "SYNC_MODE=full" | tee -a "$GITHUB_ENV"
          elif [[ "$CODE_CHANGED" == "true" ]]; then
            echo "SYNC_MODE=full" | tee -a "$GITHUB_ENV"
            echo "Site code/templates changed -> full rebuild"
          elif [[ "${GITHUB_EVENT_NAME}" == "push" && -z "${CHANGED_DATES}" ]]; then
            echo "SYNC_MODE=full" | tee -a "$GITHUB_ENV"
            echo "Push with no content changes -> full rebuild"
          else
            echo "SYNC_MODE=incremental" | tee -a "$GITHUB_ENV"
          fi
          printf '%s' "${NEW_SUB}" > "$STATE_FILE"

      # æ­¥éª¤2: å®‰è£… Hugo
      - name: Install Hugo CLI
        run: |
          wget -O ${{ runner.temp }}/hugo.deb https://github.com/gohugoio/hugo/releases/download/v${HUGO_VERSION}/hugo_extended_${HUGO_VERSION}_linux-amd64.deb \
          && sudo dpkg -i ${{ runner.temp }}/hugo.deb

      # æ­¥éª¤4: åŒæ­¥æ–°é—»æ–‡ä»¶ï¼ˆå¢é‡/å…¨é‡æŒ‰ SYNC_MODEï¼‰
      - name: Sync markdown files
        run: |
          chmod +x ./.github/scripts/sync-news.sh
          ./.github/scripts/sync-news.sh --mode="${SYNC_MODE}" --dates="${CHANGED_DATES}"

      # æ­¥éª¤5: æ„å»ºç½‘ç«™
      - name: Restore Hugo cache
        uses: actions/cache@v4
        with:
          path: ./.cache/hugo_cache
          key: hugo-cache-${{ runner.os }}-${{ github.ref_name }}-${{ github.run_id }}
          restore-keys: |
            hugo-cache-${{ runner.os }}-${{ github.ref_name }}-
            hugo-cache-${{ runner.os }}-

      - name: Build with Hugo
        env:
          HUGO_CACHEDIR: ${{ github.workspace }}/.cache/hugo_cache
          HUGO_ENVIRONMENT: production
        run: |
          hugo \
            --gc \
            --minify
          echo "=== Contents of public directory ==="
          ls -la public/

      # æ­¥éª¤6: è®¾ç½® Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: '20'
          cache: 'npm'

      # æ­¥éª¤7: å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: npm ci

      # æ­¥éª¤8: éƒ¨ç½²åˆ° Cloudflare Worker
      - name: Deploy to Cloudflare Worker
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
